name: Update Download Counter

on:
  schedule:
    - cron: '*/10 * * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout with token
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          
      - name: Get download count using Python
        id: downloads
        run: |
          python3 << 'EOF'
          import os, json, urllib.request, sys
          
          token = os.environ['GITHUB_TOKEN']
          repo = os.environ['GITHUB_REPOSITORY']
          
          url = f'https://api.github.com/repos/{repo}/releases'
          req = urllib.request.Request(url)
          req.add_header('Authorization', f'token {token}')
          
          with urllib.request.urlopen(req) as response:
              data = json.load(response)
          
          total = 0
          for release in data:
              for asset in release.get('assets', []):
                  total += asset.get('download_count', 0)
          
          print(f'total={total}')
          EOF
          
      - name: Update README
        run: |
          total="${{ steps.downloads.outputs.total }}"
          
          # Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚Ð¸Ñ€ÑƒÐµÐ¼ Ñ‡Ð¸ÑÐ»Ð¾
          formatted=$(python3 -c "
          num = $total
          if num == 0:
              print('0')
          else:
              print(f'{num:,}')
          ")
          
          echo "Updating to: $formatted downloads"
          
          # Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ñ‹Ð¹ ÑÐ¸Ð½Ñ‚Ð°ÐºÑÐ¸Ñ Ð´Ð»Ñ sed
          sed -i "s|label=[0-9,]*%20downloads|label=$formatted%20downloads|g" README.md
          
      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add README.md
          if git diff --cached --quiet; then
            echo "No changes"
          else
            git commit -m "ðŸ“¥ Downloads: ${{ steps.downloads.outputs.total }}"
            git push
          fi
