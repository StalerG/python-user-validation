name: Update Download Counter

on:
  schedule:
    - cron: '0 */6 * * *'  # –ö–∞–∂–¥—ã–µ 6 —á–∞—Å–æ–≤
  workflow_dispatch:  # –ú–æ–∂–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å –≤—Ä—É—á–Ω—É—é

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        
      - name: Get download count
        id: get_downloads
        run: |
          RESPONSE=$(curl -s "https://api.github.com/repos/${{ github.repository }}/releases")
          TOTAL=0
          
          # –ü–∞—Ä—Å–∏–º JSON –∏ —Å—É–º–º–∏—Ä—É–µ–º downloads
          while IFS= read -r count; do
            TOTAL=$((TOTAL + count))
          done < <(echo "$RESPONSE" | grep -o '"download_count":[0-9]*' | cut -d: -f2)
          
          echo "total=$TOTAL" >> $GITHUB_OUTPUT
          echo "Download count: $TOTAL"
          
      - name: Update README
        run: |
          # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —á–∏—Å–ª–æ (1,234 –≤–º–µ—Å—Ç–æ 1234)
          FORMATTED=$(printf "%'d" ${{ steps.get_downloads.outputs.total }})
          
          # –ó–∞–º–µ–Ω—è–µ–º –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä –≤ README.md
          sed -i "s/{{ DOWNLOADS_COUNT }}/$FORMATTED/g" README.md
          
      - name: Commit changes
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add README.md
          git diff --quiet && exit 0
          git commit -m "üì• Update download counter: ${{ steps.get_downloads.outputs.total }}"
          git push
